apiVersion: batch/v1
kind: Job
metadata:
  name: reset-db
  namespace: kubeflow
spec:
  parallelism: 1
  completions: 1
  ttlSecondsAfterFinished: 10
  template:
    metadata:
      annotations:
        "sidecar.istio.io/inject": "false"
    spec:
      containers:
      - name: reset-db
        image: mysql:8.0.26
        command: 
        - mysql 
        - -u 
        - $(DBCONFIG_USER)
        - -p$(DBCONFIG_PASSWORD)
        - -h 
        - $(DBCONFIG_HOST_NAME) 
        - -e 
        - "drop database if exists mlpipeline; drop database if exists metadb; drop database if exists cachedb; create database if not exists mlpipeline;create database if not exists metadb; create database if not exists cachedb;"
        env:
        - name: DBCONFIG_USER
          valueFrom:
            secretKeyRef:
              key: username
              name: mysql-secret
        - name: DBCONFIG_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: mysql-secret
        - name: DBCONFIG_HOST_NAME
          valueFrom:
            configMapKeyRef:
              key: dbHost
              name: pipeline-install-config
      restartPolicy: Never
  backoffLimit: 4